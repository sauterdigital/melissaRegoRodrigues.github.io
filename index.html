<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lúcio 2.0</title>

    <!-- CSS padrão do Dialogflow Messenger -->
    <link rel="stylesheet" href="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/themes/df-messenger-default.css">

    <style>
      df-messenger {
        z-index: 999;
        position: fixed;
        --df-messenger-font-color: #000;
        --df-messenger-font-family: Google Sans;
        --df-messenger-chat-background: #f3f6fc;
        --df-messenger-message-user-background: #d3e3fd;
        --df-messenger-message-bot-background: #fff;
        bottom: 16px;
        right: 16px;
      }

      /* Elementos extras do seu script */
      #impostor-upload-container {
        position: fixed;
        display: none;
        z-index: 1000;
        width: 32px;
        height: 32px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background-color 0.2s;
      }
      #impostor-upload-container:hover {
        background-color: rgba(0, 0, 0, 0.08);
      }
      #impostor-upload-container svg {
        width: 24px;
        height: 24px;
        fill: #5f6368;
      }

      #click-detector {
        position: fixed;
        bottom: 16px;
        right: 16px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        z-index: 1001;
        cursor: pointer;
      }
    </style>
</head>
<body>

    <h1>Testes do Lúcio 2.0</h1>

    <!-- Script oficial do Dialogflow -->
    <script src="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/df-messenger.js"></script>

    <!-- ========================== -->
    <!--     DIALOGFLOW WIDGET     -->
    <!-- ========================== -->
    <df-messenger
      location="us"
      project-id="prj-dev-dis-cbl-cple"
      agent-id="8e664718-ebfd-4b38-aae9-91f9a0762c1c"
      language-code="pt-br"
      max-query-length="-1">
      <df-messenger-chat-bubble
        chat-title="Lucio-2.0"
        enable-file-upload>
      </df-messenger-chat-bubble>
    </df-messenger>

    <!-- ========================== -->
    <!--        SCRIPT EXTRA        -->
    <!-- ========================== -->
    <script>
        const MAX_WIDTH = 500;
        const MAX_HEIGHT = 500;
        const COMPRESSION_QUALITY = 0.5;

        const HIDDEN_TRIGGER_QUERY = '__USUARIO_ENVIANDO_IMAGEM__';
        const DF_PARAMETER_NAME = 'imageBase64';

        console.log('[DEBUG] Script de upload (versão GATILHO ESCONDIDO + ANTI-DUPLICADO) iniciado.');

        let dfMessengerInstance = null;
        let isProcessingImage = false;
        let lastImageBase64 = null;

        function processAndSendImageFromBlob(imageBlob) {
            if (!dfMessengerInstance) { return; }

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;

                img.onload = async () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    let width = img.width, height = img.height;

                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width *= MAX_HEIGHT / height;
                            height = MAX_HEIGHT;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;

                    ctx.drawImage(img, 0, 0, width, height);

                    const fullBase64 = canvas.toDataURL('image/jpeg', COMPRESSION_QUALITY);
                    const pureBase64 = fullBase64.split(',')[1];
                    const urlSafeBase64 = pureBase64.replace(/\+/g, '-').replace(/\//g, '_');

                    if (urlSafeBase64 === lastImageBase64) {
                        isProcessingImage = false;
                        return;
                    }

                    console.log("Imagem processada, enviando ao agente...");

                    const queryParameters = {
                        parameters: {
                            [DF_PARAMETER_NAME]: urlSafeBase64
                        }
                    };

                    try {
                        lastImageBase64 = urlSafeBase64;

                        dfMessengerInstance.setQueryParameters(queryParameters);
                        await dfMessengerInstance.sendQuery(HIDDEN_TRIGGER_QUERY);

                        console.log('Query escondida enviada.');

                    } catch (error) {
                        console.error("ERRO ao enviar imagem:", error);
                        dfMessengerInstance.renderCustomText('Ocorreu um erro ao enviar a imagem.');
                        lastImageBase64 = null;
                    } finally {
                        dfMessengerInstance.setQueryParameters({ parameters: {} });
                        isProcessingImage = false;
                    }
                };
            };
            reader.readAsDataURL(imageBlob);
        }

        function activateInterceptor() {
            if (window.interceptorActivated) return;

            const originalCreateObjectURL = URL.createObjectURL;

            URL.createObjectURL = function(blob) {
                if (isProcessingImage) return originalCreateObjectURL.apply(this, arguments);

                if (blob && blob.type && blob.type.startsWith('image/')) {
                    isProcessingImage = true;
                    console.log('[SUCESSO] Imagem interceptada.');
                    processAndSendImageFromBlob(blob);
                    return null;
                }

                return originalCreateObjectURL.apply(this, arguments);
            };

            window.interceptorActivated = true;

            console.log('[DEBUG] Interceptador ativo.');
        }

        const dfMessenger = document.querySelector('df-messenger');

        function onChatReady() {
            console.log('[DEBUG] Chat carregado.');
            dfMessengerInstance = document.querySelector('df-messenger');
            dfMessengerInstance.sendQuery("oi");
            activateInterceptor();
        }

        if (dfMessenger.shadowRoot && dfMessenger.shadowRoot.innerHTML !== '') {
            onChatReady();
        } else {
            dfMessenger.addEventListener('df-messenger-loaded', onChatReady);
        }
    </script>

</body>
</html>

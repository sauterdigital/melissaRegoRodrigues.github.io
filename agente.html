<link rel="stylesheet" href="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/themes/df-messenger-default.css">
<script src="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/df-messenger.js"></script>
<df-messenger
  location="us"
  project-id="prj-dev-dis-cbl-cple"
  agent-id="8e664718-ebfd-4b38-aae9-91f9a0762c1c"
  language-code="pt-br"
  max-query-length="-1">
  <df-messenger-chat-bubble
    chat-title="Lucio-2.0" enable-file-upload
    > </df-messenger-chat-bubble>
</df-messenger>

<style>
  /* Seu CSS original do df-messenger */
  df-messenger {
    z-index: 999;
    position: fixed;
    bottom: 16px;
    right: 16px;
    /* ...outros estilos... */
  }

 
  #impostor-upload-container {
    position: fixed; 
    display: none;   
    z-index: 1000;
    width: 32px;
    height: 32px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background-color 0.2s;
  }
  #impostor-upload-container:hover { background-color: rgba(0, 0, 0, 0.08); }
  #impostor-upload-container svg { width: 24px; height: 24px; fill: #5f6368; }
  
  #click-detector {
    position: fixed;
    bottom: 16px; 
    right: 16px;  
    width: 60px;  
    height: 60px; 
    border-radius: 50%;
    z-index: 1001; 
    cursor: pointer;
    
  }
</style>

<script>
    const MAX_WIDTH = 500;
    const MAX_HEIGHT = 500;
    const COMPRESSION_QUALITY = 0.5;
    
    const HIDDEN_TRIGGER_QUERY = '__USUARIO_ENVIANDO_IMAGEM__';
    const DF_PARAMETER_NAME = 'imageBase64';
    

    console.log('[DEBUG] Script de upload (versão GATILHO ESCONDIDO + ANTI-DUPLICADO) iniciado.');

    let dfMessengerInstance = null;
    let isProcessingImage = false;
    let lastImageBase64 = null; // <-- NOSSA NOVA VARIÁVEL

    function processAndSendImageFromBlob(imageBlob) {
        if (!dfMessengerInstance) { return; }

        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = async () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                let width = img.width, height = img.height;
                if (width > height) { if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; } }
                else { if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; } }
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                const fullBase64 = canvas.toDataURL('image/jpeg', COMPRESSION_QUALITY);
                const pureBase64 = fullBase64.split(',')[1];
                const urlSafeBase64 = pureBase64.replace(/\+/g, '-').replace(/\//g, '_');

                // ==================================================================
                //                  INÍCIO DA LÓGICA ANTI-DUPLICADO
                // ==================================================================
                if (urlSafeBase64 === lastImageBase64) {
                    
                    // Precisamos liberar a trava para o usuário poder enviar OUTRA imagem
                    isProcessingImage = false; 
                    return; // Aborta o envio
                }
                // ==================================================================
                //                   FIM DA LÓGICA ANTI-DUPLICADO
                // ==================================================================

                console.log("-----------------------------------------");
                console.log("✅ Imagem processada! Enviando com gatilho de query...");

                const queryParameters = { parameters: { [DF_PARAMETER_NAME]: urlSafeBase64 } };
                
                try {
                    // Guarda o Base64 da imagem que estamos prestes a enviar
                    lastImageBase64 = urlSafeBase64; 

                    dfMessengerInstance.setQueryParameters(queryParameters);
                    await dfMessengerInstance.sendQuery(HIDDEN_TRIGGER_QUERY);
                    
                    console.log(`Gatilho "${HIDDEN_TRIGGER_QUERY}" enviado com sucesso.`);

                } catch (error) {
                    console.error("ERRO ao enviar a query de gatilho:", error);
                    dfMessengerInstance.renderCustomText('Ocorreu um erro ao enviar a imagem.');
                    
                    // Se deu erro, limpa o "último" Base64 para permitir tentar de novo
                    lastImageBase64 = null; 
                } finally {
                    dfMessengerInstance.setQueryParameters({ parameters: {} });
                    isProcessingImage = false;
                    console.log("Processo finalizado, trava liberada.");
                }
                console.log("-----------------------------------------");
            };
        };
        reader.readAsDataURL(imageBlob);
    }

    function activateInterceptor() {
        if (window.interceptorActivated) return;
        const originalCreateObjectURL = URL.createObjectURL;
        URL.createObjectURL = function(blob) {
            if (isProcessingImage) return originalCreateObjectURL.apply(this, arguments);
            if (blob && blob.type && blob.type.startsWith('image/')) {
                isProcessingImage = true;
                console.log('%c[SUCESSO] Blob de imagem interceptado! TRAVA ATIVADA.', 'color: green; font-weight: bold;');
                processAndSendImageFromBlob(blob);
                return null;
            }
            return originalCreateObjectURL.apply(this, arguments);
        };
        window.interceptorActivated = true;
        console.log('[DEBUG] Interceptador de upload está ATIVO.');
    }

    const dfMessenger = document.querySelector('df-messenger');
    function onChatReady() {
        console.log('[DEBUG] Chat está 100% pronto.');
        dfMessengerInstance = document.querySelector('df-messenger');
        dfMessengerInstance.sendQuery("oi");
        activateInterceptor();
    }
    if (dfMessenger.shadowRoot && dfMessenger.shadowRoot.innerHTML !== '') {
        onChatReady();
    } else {
        dfMessenger.addEventListener('df-messenger-loaded', onChatReady);
    }

</script>